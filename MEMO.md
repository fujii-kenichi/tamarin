# いろいろなメモ

開発用のいろいろなメモです。適当に思いつくまま書いています。

## デバッグについて

- 全てのページへのリンクを書いた DEBUG 用ページ (localhost だったら <http://localhost:8000/connector/debug>, クラウドにデプロイした後なら FQDN/connector/debug )をブックマークしておくと便利。
- PWA は結構デバッグがめんどう。特に実機がからむタマリンカメラはめんどくさい。PWA なので JavaScript や html や css といった構成ファイルは全部 service worker が明示的にキャッシュしている。なのでどんなにサーバ側で変えても反映されない。ってことで、タマリンカメラのデバッグは以下のような感じでできるようにした。
  - まず service worker が違うキャッシュだと認識するために tamarin/settings.py にある VERSION の値を変える。昔使った値にするとそれが残っている場合にまたやっかいなので、全然違う値にするのがベター。
  - 次に service worker 自身が前と違うとブラウザに認識してもらう必要がある。それはどうやら .js ファイルのバイトサイズをみているということなので、.js ファイルのサイズを変える必要がある。冒頭の不思議なコメントはこのためのもので、これを適当に伸ばしてこの条件を充足する。
  - これで再度アクセスすると service worker の新しいインスタンスが読み込まれ、新しいバージョンに基づいたキャッシュがセットアップされ、めでたく変更した js や html や css が読み込まれる"はず"である。service worker に該当のイベントがでるのにはちょっと時間がかかるようなので、焦らずにまつこと。
- 実機はさすがにめんどくさいのでローカルPCでのブラウザやシミュレータでやりたくなる。ローカルマシンのブラウザに関連するメモは以下の通り：
  - スマホだとカメラが2個あるのだけどPCは普通一個なので getUserMedia で指定する値が異なる。あんまりにもめんどくさいのでこれを判定するコードを結局いれちゃったけど、実際にカメラからくる画像のサイズやバイト数はスマホのものとは違うことに要注意。
  - Windows の chrome だとそれでもカメラが撮れるけど、Mac の chrome は取れない。でも Safari だと撮れる。不思議...なにかコードに間違いがあるのかもしれない。
  - ブラウザでタマリンカメラをデバッグするには chrome devtool や safari の開発メニューが便利。
- また、シミュレータでのメモは以下の通り：
  - シミュレータ(iPhoneはXcodeの、AndroidはAndroid Studioから呼び出せるやつ)だと残念ながらカメラがやっぱりちゃんと出ない。
  - 結局 localhost で動いている Django を使っている場合には、PWA の構成要件である https が成立しないのでアプリとしてはインストールはできない模様。もちろん Web サイトとして実行することはできる。
- 実機でデバッグする場合、PWA は OS から見れば Web ブラウザが動いているだけなので、通常のデバッガはあんまり使えない（使いこなせていないだけという噂もある）
  - モバイル Safari は USB ケーブルで繋げた母艦(Mac)の Safari からアタッチできるので、これは結構便利。

----

## 現在の各種設定値

- 扱えるメディアの最大サイズ
  - 8MB を tamarin/settings.py で指定。暗号化をオンにすると途中で BASE64 にするのでもとの3/2倍になるので要注意! しかも今のタマリンカメラではこの値を見ていないので(単なる手抜き)アップロードするとコネクタが拒絶して400になる...
- タマリンカメラで保持できる写真の枚数
  - 10枚を camera/views.py で定義。1枚のサイズが大きいと最後は IndexedDB がいっぱいになっちゃうかも。特にモバイル Safari では要注意！
- シーンや状況タグの最大長や最大数
  - データベースのレコード長としては connector/models.py で250で定義。ただタマリンクではエラーチェックしていないです。
- JWTトークンの有効期限
  - tamarin/settings.py で定義していて、DBEUG じゃなければ60分、DEBUG の時は1分。
