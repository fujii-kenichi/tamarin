# いろいろなメモ

開発用のいろいろなメモです。適当に思いつくまま書いています。

----

## デバッグについて

- 全てのページへのリンクを書いた DEBUG 用ページ (localhost だったら <http://localhost:8000/connector/debug>, クラウドにデプロイした後なら FQDN/connector/debug )をブックマークしておくと便利。
- PWA は結構デバッグがめんどう。特に実機がからむタマリンカメラはめんどくさい。PWA なので JavaScript や html や css といった構成ファイルは全部 service worker が明示的にキャッシュしている。なのでどんなにサーバ側で変えても反映されない。ってことで、タマリンカメラのデバッグは以下のような感じでできるようにした。
  - まず service worker が違うキャッシュだと認識するために tamarin/settings.py にある VERSION の値を変える。昔使った値にするとそれが残っている場合にまたやっかいなので、全然違う値にするのがベター。
  - 次に service worker 自身が前と違うとブラウザに認識してもらう必要がある。それはどうやら .js ファイルのバイトサイズをみているということなので、.js ファイルのサイズを変える必要がある。冒頭の不思議なコメントはこのためのもので、バージョンに基づいたランダムさで views.py によってダミーのコメントを自動生成することで、ブラウザエンジンが認識するファイルのサイズを自動的に変えている。
  - これで再度アクセスすると service worker の新しいインスタンスが読み込まれ、新しいバージョンに基づいたキャッシュがセットアップされ、めでたく変更した js や html や css が読み込まれる"はず"である。service worker に該当のイベントがでるのにはちょっと時間がかかるようなので、焦らずにまつこと。せっかちな人のために、設定画面のバージョンを押すとカッシュをクリアして強制的に更新する機能も設けてある。
- 実機はさすがにめんどくさいのでローカルPCでのブラウザやシミュレータでやりたくなる。ローカルマシンのブラウザに関連するメモは以下の通り：
  - スマホだとカメラが2個あるのだけどPCは普通一個なので getUserMedia で指定する値が異なる。あんまりにもめんどくさいのでこれを判定するコードを結局いれちゃったけど、実際にカメラからくる画像のサイズやバイト数はスマホのものとは違うことに要注意。
  - Windows の chrome だとそれでもカメラが撮れるけど、Mac の chrome は取れない。でも Safari だと撮れる。不思議...なにかコードに間違いがあるのかもしれない。
  - ブラウザでタマリンカメラをデバッグするには chrome devtool や safari の開発メニューが便利。
- また、シミュレータでのメモは以下の通り：
  - シミュレータ(iPhone は Xcode の、Android は Android Studio から呼び出せるやつ)だと残念ながらカメラがやっぱりちゃんと出ない。
  - 結局 localhost で動いている Django を使っている場合には、PWA の構成要件である https が成立しないのでアプリとしてはインストールはできない模様。もちろん Web サイトとして実行することはできる。
- 実機でデバッグする場合、PWA は OS から見れば Web ブラウザが動いているだけなので、通常のデバッガはあんまり使えない（使いこなせていないだけという噂もある）
  - モバイル Safari は USB ケーブルで繋げた母艦(Mac)の Safari からアタッチできるので、これは結構便利。
- 実際の Deploy の前に python3 manage.py correctstatic; python3 manage.py check --deploy をしてみるといいかも。HSTS とかはまださすがに対応できないけど...
- そういえば Python / Django 部分のデバッグには、もちろんログをちゃんと出すのが一番いいんだけど、めんどくさい時は print() でメッセージを出すようにして、python3 -u manage.py runserver と -u をつけて起動するとなにげにみることができる模様.

----

## アプリのアップデートについて

- デバッグのところにも書いたけど、PWA は基本的にブラウザエンジンが新しい Web ページを読み込むことがそのままアプリのバージョンアップとなる。
- タマリンクは、オフライン起動はできないという仕様なので service worker でのキャッシュコントロールをしていない。したがって、単純に普通の Web コンテンツのようにサーバ側でデプロイしているファイルをアップデートすれば、それがそのままアプリのアップデートにつながるはず。
- 問題はタマリンカメラで、オフライン運用ができるようにするために(PWA の本領発揮!) service worker で自力でのキャッシュ制御をしている。このあたりはデバッグの項に書いた通り。
- PWA としてインストールした「アプリ」に対して、ブラウザエンジンがどういうタイミングで service worker の更新を確認しているのか、ちょっと具体的に記述している資料を見つけることができなかった。このあたりは Android chrome なのか iOS Safari なのかでも違いそうなので、ちゃんとそれぞれの環境で動作確認をしてユーザーから見た「仕様を確定」する必要がありそう。
- タマリンカメラでは、設定画面からでるバージョンをクリックすることで強制アップデート(正確にはキャッシュをクリアして自分自身を再読み込みする)機能をつけてある。技術的にはこの方法で強制アップデートが可能っぽいので、あとはインストール時の導線設計といっしょに改善を図るべきだろう。

----

## Bulma をカスタマイズして見た目を変えるときには

- 0.0.3 から CSS フレームワーク Bulma を使用して見た目を劇的に改善した。ただ Bulma のカスタマイズはちょっとひと手間が必要なので忘れないようにメモ。

- まず bulma フォルダで node-sass を使えるようにする。

  ```bash
  npm install -D node-sass
  ```

- my-bulma.scss を適宜編集する。
- ビルドして bulma.css を得る。

  ```bash
  npm run build
  ```

----

## 写真の非同期アップロードと PWA の service worker について

- service worker に sync イベントがこない環境では、写真のアップロードはタマリンカメラが起動している時しか行われない。
- 具体的には iphone の safari では現時点で sync が未サポート (see also <https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/sync>)
- Android の chrome ではサポートされているので、写真のアップロードはオフラインからオンラインになったらタマリンカメラが表にでていなくても裏で行われる。
- iPhone での非同期アップロードをどうするかは大きな課題。オフライン撮影したらオンラインになった時にタマリンカメラを起動してください、で仕様にするしか現時点ではなさそう。

----

## Azure にデプロイしたときの簡単な動作確認の方法

- ハートビートURL <https://サービスドメイン名/heartbeat> でレスポンスが返ってくるか? 返って来れば App Service は動いている。
- Django 管理URL <https://サービスドメイン名/manager> はアクセスできるか? アクセスできればデータベースもつながって動いている。
- タマリンカメラで写真をアップロードできるか? アップロードできれば Azure ストレージへのライトは動いている。
- タマリンクで写真をダウンロードできるか? ダウンロードできれば Azure ストレージへのリードは動いている。ライトは App Service 経由だけどリードは Azure ストレージから(CORSをクリアした上)直接もってくるので、ライトができるからといってリードができるわけではないので要注意!
- ちなみに Azure App Service は無料プランだと一定時間アクセスがないと寝ちゃうのでこれまた要注意!

----

## 各種設定値

- 撮影される写真の解像度
  - 1920x1080 を camera/views.py で指定。ちなみに、safari では ImageCapture が実装されていないので自前のコードでビデオのフレームをもってきている。そのため、あんまり画質がよくない。Android というか Chrome 環境では ImageCapture があるので「静止画のキャプチャ」としての画質をもった撮影が期待できるはず。
- 扱える写真の最大サイズ
  - 4MB を tamarin/settings.py で指定。暗号化をオンにすると途中で BASE64 にするのでもとの3/2倍になるので要注意! しかも今のタマリンカメラではこの値を見ていないので(単なる手抜き)アップロードするとコネクタが拒絶して400になる...
- オフライン状態で保持できる写真の枚数
  - 10枚を camera/views.py で定義。1枚のサイズが大きいと最後は IndexedDB がいっぱいになっちゃうかも。特にモバイル Safari では要注意! IndexedDB 全体で合計 10MB までという噂。
- コネクタで保管できる写真の枚数
  - 現時点では制約なし。
- シーンタグやコンテキストタグの最大長
  - CSV 化したあとのデータベースのレコード長としては tamarin/settings.py で250と定義。
  - CSV 化する前の文字列としては tamarin/settings.py で最長25文字で定義。
- ユーザー名やパスワードや利用者名などの最大長
  - tamarin/settings.py で最短6文字最長50文字で定義。
- JWT トークンの有効期限
  - tamarin/settings.py で定義していて、DBEUG じゃなければ60分、DEBUG の時は1分。

## 仕様

- iPhone ではバックグラウンドでのアップロードができない (service worker に sync 機能がないから)
- Safari ではタマリンクがうごかない (FileSystem API がないから)
- ユーザ名に日本語がつかえない (API で URL の一部になる場合があるのと、そもそも UNICODE を許すと人間から見て一意性のある文字列にならない場合があるということで意図的に ASCII に制限)
- タマリンクがオフラインでは動作しない (オフラインで動いても意味がないので意図的な仕様)

----

## そのうちいつかやること (優先度の高いやるべきことは Issue に移動)

- API のバージョニングがされていない：Django REST Framework のベストプラクティスを採用して設定する。
- ユーザーが入力したパスワードを IndexedDB に(復号可能な暗号化をして)永続化している：これは特にオフライン運用が想定されるタマリンカメラで認証ダイアログをださないようにするための意図的な仕様なんだけど、この是非は一回ちゃんと考えたほうがいいかも。
- コネクタのセキュリティ診断をやってみる： Django の設定で基本的なことはやってあるが、CSP、HSTS なんかは未対応。
- 多言語化の対応が中途半端：今のところ models.py と settings.py と .html の3箇所を対応する必要があるけど、Django 標準に準拠した方式へさっさと移行するべき。
- リフレッシュトークンの使用をさぼっている：いまはさぼってアクセストークンだけで処理しているけど、これをちゃんとリフレッシュトークンも使うように変える。
- 暗号化関連処理を Web 標準に変える：今は CryptoJS を使っているけど、PWA でそもそも実行環境が制限できるのだから Web 標準機能に乗り換えるほうが安全性とか性能とかからみてよさそう。
- PWA の利点を生かして GA などの解析機能を入れる：外部から環境変数で注入するというイメージ。
- Google の Lighthouse でサイトの状態を確認する：PWA 対応のスコアも出るので参考になる。なぜか chrome で動かない場合は npm install -g lighthouse-chromium でローカルに入れることもできる。
- JS や html や css を静的解析のツールに通したい：今よりもなんかいいツールを探してみたい。
