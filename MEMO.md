# いろいろなメモ

開発用のいろいろなメモです。適当に思いつくまま書いています。

## デバッグについて

- 全てのページへのリンクを書いた DEBUG 用ページ (localhost だったら <http://localhost:8000/connector/debug>, クラウドにデプロイした後なら FQDN/connector/debug )をブックマークしておくと便利。
- PWA は結構デバッグがめんどう。特に実機がからむタマリンカメラはめんどくさい。PWA なので JavaScript や html や css といった構成ファイルは全部 service worker が明示的にキャッシュしている。なのでどんなにサーバ側で変えても反映されない。ってことで、タマリンカメラのデバッグは以下のような感じでできるようにした。
  - まず service worker が違うキャッシュだと認識するために tamarin/settings.py にある VERSION の値を変える。昔使った値にするとそれが残っている場合にまたやっかいなので、全然違う値にするのがベター。
  - 次に service worker 自身が前と違うとブラウザに認識してもらう必要がある。それはどうやら .js ファイルのバイトサイズをみているということなので、.js ファイルのサイズを変える必要がある。冒頭の不思議なコメントはこのためのもので、バージョンに基づいたランダムさで views.py によってダミーのコメントを自動生成することで、ブラウザエンジンが認識するファイルのサイズを自動的に変えている。
  - これで再度アクセスすると service worker の新しいインスタンスが読み込まれ、新しいバージョンに基づいたキャッシュがセットアップされ、めでたく変更した js や html や css が読み込まれる"はず"である。service worker に該当のイベントがでるのにはちょっと時間がかかるようなので、焦らずにまつこと。せっかちな人のために、設定画面のバージョンを押すとカッシュをクリアして強制的に更新する機能も設けてある。
- 実機はさすがにめんどくさいのでローカルPCでのブラウザやシミュレータでやりたくなる。ローカルマシンのブラウザに関連するメモは以下の通り：
  - スマホだとカメラが2個あるのだけどPCは普通一個なので getUserMedia で指定する値が異なる。あんまりにもめんどくさいのでこれを判定するコードを結局いれちゃったけど、実際にカメラからくる画像のサイズやバイト数はスマホのものとは違うことに要注意。
  - Windows の chrome だとそれでもカメラが撮れるけど、Mac の chrome は取れない。でも Safari だと撮れる。不思議...なにかコードに間違いがあるのかもしれない。
  - ブラウザでタマリンカメラをデバッグするには chrome devtool や safari の開発メニューが便利。
- また、シミュレータでのメモは以下の通り：
  - シミュレータ(iPhone は Xcode の、Android は Android Studio から呼び出せるやつ)だと残念ながらカメラがやっぱりちゃんと出ない。
  - 結局 localhost で動いている Django を使っている場合には、PWA の構成要件である https が成立しないのでアプリとしてはインストールはできない模様。もちろん Web サイトとして実行することはできる。
- 実機でデバッグする場合、PWA は OS から見れば Web ブラウザが動いているだけなので、通常のデバッガはあんまり使えない（使いこなせていないだけという噂もある）
  - モバイル Safari は USB ケーブルで繋げた母艦(Mac)の Safari からアタッチできるので、これは結構便利。
- 実際の Deploy の前に python3 manage.py correctstatic; python3 manage.py check --deploy をしてみるといいかも。HSTS とかはまださすがに対応できないけど...

## アプリのアップデートについて

- デバッグのところにも書いたけど、PWA は基本的にブラウザエンジンが新しい Web ページを読み込むことがそのままアプリのバージョンアップとなる。
- タマリンクは、オフライン起動はできないという仕様なので service worker でのキャッシュコントロールをしていない。したがって、単純に普通の Web コンテンツのようにサーバ側でデプロイしているファイルをアップデートすれば、それがそのままアプリのアップデートにつながるはず。
- 問題はタマリンカメラで、オフライン運用ができるようにするために(PWA の本領発揮!) service worker で自力でのキャッシュ制御をしている。このあたりはデバッグの項に書いた通り。
- PWA としてインストールした「アプリ」に対して、ブラウザエンジンがどういうタイミングで service worker の更新を確認しているのか、ちょっと具体的に記述している資料を見つけることができなかった。このあたりは Android chrome なのか iOS Safari なのかでも違いそうなので、ちゃんとそれぞれの環境で動作確認をしてユーザから見た「仕様を確定」する必要がありそう。
- タマリンカメラでは、設定画面からでるバージョンをクリックすることで強制アップデート(正確にはキャッシュをクリアして自分自身を再読み込みする)機能をつけてある。技術的にはこの方法で強制アップデートが可能っぽいので、あとはインストール時の導線設計といっしょに改善を図るべきだろう。

## APP_DEBUG = True の時にタマリンカメラにでる「芋虫」について

APP_DEBUG を True でデプロイすると、タマリンカメラのメニューの右端に「芋虫」のボタンがでる。これは実機デバッグ用のメニュー。なかなかシミュレータとかPCのブラウザ環境では見ることのできない実機での問題を確認・解消するためのもの。以下に簡単な使い方を示す。

- [Ｘ] デバッグ用の画面を閉じる。
- [LD] ログを表示バッファにロードする。ログは JS の console.info(), console.warn(), console.error() の各出力を覚えている。なぜか JSON で出るが、これはオブジェクトのダンプを JSON 化でさぼっているため。なので JSON 化できないオブジェクトが引数にあった出力はちゃんとログに出ない。
- [CLR] ログバッファをクリアする。現時点から先のログだけを見たい時に便利。
- [RST] IndexedDB の User と Photo を全部クリアする。要するにアカウントの情報と転送待ちの写真を削除する。確認とかしないので注意。例えばコネクタが何らかの理由で常に400を返すような状態になってしまった場合などに使う。こういう時でもタマリンカメラは延々とアップロードをリトライしつづけてしまう。この機能で IndexedDB をクリアすればこの状態を解除できる。
- [V] VIDEOタグで出しているプレビューをリセットする。ストリームを取り直してもういちど接続し直す。なぜか実機ではよくこのプレビューが出なくなるという症状が見られるので、そのデバッグ用に設けている。

## 写真の非同期アップロードと PWA の service worker について

- service worker に sync イベントがこない環境では、写真のアップロードはタマリンカメラが起動している時しか行われない。
- 具体的には iphone の safari では現時点で sync が未サポート (see also <https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/sync>)
- Android の chrome ではサポートされているので、写真のアップロードはオフラインからオンラインになったらタマリンカメラが表にでていなくても裏で行われる。
- iPhone での非同期アップロードをどうするかは大きな課題。オフライン撮影したらオンラインになった時にタマリンカメラを起動してください、で仕様にするしか現時点ではなさそう。

## Azure にデプロイしたときの簡単な動作確認の方法

- ハートビートURL <https://サービスドメイン名/heartbeat> でレスポンスが返ってくるか？ 返って来れば App Service は動いている。
- Django 管理URL <https://サービスドメイン名/manager> はアクセスできるか？ アクセスできればデータベースもつながって動いている。
- タマリンカメラで写真をアップロードできるか？ アップロードできれば Azure ストレージへのライトは動いている。
- タマリンクで写真をダウンロードできるか？ ダウンロードできれば Azure ストレージへのリードは動いている。ライトは App Service 経由だけどリードは Azure ストレージから直接なので、ライトができるからといってリードができるわけではないので要注意！
- ちなみに Azure App Service は無料プランだと一定時間アクセスがないと寝ちゃうのでこれまた要注意！

## 現在の各種設定値

- 撮影される写真の解像度
  - 1920x1080 を camera/views.py で指定。実際のサイズは環境次第だけど、少なくとも iPhone と iPod はこのサイズで返ってきているみたい。
- 扱える写真の最大サイズ
  - 8MB を tamarin/settings.py で指定。暗号化をオンにすると途中で BASE64 にするのでもとの3/2倍になるので要注意! しかも今のタマリンカメラではこの値を見ていないので(単なる手抜き)アップロードするとコネクタが拒絶して400になる...
- オフライン状態で保持できる写真の枚数
  - 10枚を camera/views.py で定義。1枚のサイズが大きいと最後は IndexedDB がいっぱいになっちゃうかも。特にモバイル Safari では要注意！
- シーンや状況タグの最大長や最大数
  - データベースのレコード長としては connector/models.py で250で定義。ただタマリンクではエラーチェックしていないです。
- JWTトークンの有効期限
  - tamarin/settings.py で定義していて、DBEUG じゃなければ60分、DEBUG の時は1分。

## 現在の仕様

- iPhone ではバックグラウンドでのアップロードができない (service worker に sync 機能がないから)
- PC の Safari ではタマリンクがうごかない (FileSystem API がないから)
- ユーザ名に日本語がつかえない (API で URL の一部になる場合があるのと、そもそも UNICODE を許すと人間から見て一意性のある文字列にならない場合があるということで意図的に ASCII に制限)
- タマリンクがオフラインでは動作しない (オフラインで動いても意味がないので意図的な仕様)

## そのうちいつかやること (優先度の高いやるべきことは Issue に移動)

- Django の標準管理コンソールでユーザ管理がちゃんとできない：これ普通にカスタマイズした User モデルに対応する処理をいれればいいだけなはず。
- API のバージョニングがされていない：Django REST Framework のベストプラクティスを採用して設定する。
- ユーザが入力したパスワードを IndexedDB に(復号可能な暗号化をして)永続化している：これは特にオフライン運用が想定されるタマリンカメラで認証ダイアログをださないようにするための意図的な仕様なんだけど、この是非は一回ちゃんと考えたほうがいいかも。
- コネクタのセキュリティ診断をやってみる： Django の設定で基本的なことはやってあるが、CSP、HSTS なんかは未対応。
- 多言語化の対応が中途半端：今のところ models.py と settings.py と .html の3箇所を対応する必要があるけど、Django 標準に準拠した方式へさっさと移行するべき。
- リフレッシュトークンの使用をさぼっている：いまはさぼってアクセストークンだけで処理しているけど、これをちゃんとリフレッシュトークンも使うように変える。
- タマリンカメラの Debug log 機能で出力できない情報がある：手抜きの Json 化で凌いでいるけど、本当はちゃんとObjectをみてダンプできるようにしたい。
- 暗号化関連処理を Web 標準に変える：今は CryptoJS を使っているけど、PWA でそもそも実行環境が制限できるのだから Web 標準機能に乗り換えるほうが安全性とか性能とかからみてよさそう。
- PWA の利点を生かして GA などの解析機能を入れる：外部から環境変数で注入するというイメージ。
- Google の Lighthouse でサイトの状態を確認する：PWA 対応のスコアも出るので参考になる。なぜか chrome で動かない場合は npm install -g lighthouse-chromium でローカルに入れることもできる。
- JS や html や css を静的解析のツールに通したい：今よりもなんかいいツールを探してみたい。
