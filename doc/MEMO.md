# いろいろなメモ

開発用のいろいろなメモです。適当に思いつくまま書いています。

## デバッグについて

- すべてのページへのリンクを書いたDEBUG用ページ（localhostだったら<http://localhost:8000/connector/debug>、クラウドにデプロイした後ならFQDN/connector/debug）をブックマークしておくと便利。
- PWAは結構デバッグがめんどう。とくに実機がからむタマリンカメラはめんどくさい。PWAなのでJavaScriptやhtmlやcssといった構成ファイルは全部service workerが明示的にキャッシュしている。なのでどんなにサーバ側で変えても反映されない。ってことで、タマリンカメラのデバッグは以下のような感じでできるようにした。
  - まずservice workerが違うキャッシュだと認識するためapp-settings.pyにあるVERSIONの値を変える。昔使った値にするとそれが残っている場合にまたやっかいなので、全然違う値にするのがベター。
  - 次にservice worker自身が前と違うとブラウザに認識してもらう必要がある。それはどうやらjsファイルのバイトサイズをみているということなのでjsファイルのサイズを変える必要がある。冒頭の不思議なコメントはこのためのもので、バージョンに基づいたランダムさでviews.pyによってダミーのコメントを自動生成することで、ブラウザエンジンが認識するファイルのサイズを自動的に変えている。
  - これで再度アクセスするとservice workerの新しいインスタンスが読み込まれ、新しいバージョンに基づいたキャッシュがセットアップされ、めでたく変更したjsやhtmlやcssが読み込まれる"はず"である。service workerに該当のイベントがでるのにはちょっと時間がかかるようなので、焦らずにまつこと。せっかちな人のために、設定画面のバージョンを押すとカッシュをクリアして強制的に更新する機能も設けてある。
- 実機はさすがにめんどくさいのでローカルPCでのブラウザやシミュレータでやりたくなる。ローカルマシンのブラウザに関連するメモは以下の通り:
  - スマホだとカメラが2個あるのだけどPCは普通一個なのでgetUserMediaで指定する値が異なる。あんまりにもめんどくさいのでこれを判定するコードを結局いれちゃったけど、実際にカメラからくる画像のサイズやバイト数はスマホのものとは違うことに要注意。
  - Windowsのchromeだとそれでもカメラが撮影できるけど、Macのchromeは取れない。でもsafariだと撮れる。不思議…なにかコードに間違いがあるのかもしれない。
  - ブラウザでタマリンカメラをデバッグするにはchrome devtoolやsafariの開発メニューが便利。
- また、シミュレータでのメモは以下の通り:
  - シミュレータ（iPhoneはXcodeの、AndroidはAndroid Studioから呼び出せるやつ）だと残念ながらカメラがやっぱりちゃんと出ない。
  - 結局localhostで動いているDjangoを使っている場合には、PWAの構成要件であるhttpsが成立しないのでアプリとしてはインストールはできない模様。もちろんWebサイトとして実行することはできる。
- 実機でデバッグする場合、PWAはOSから見ればWebブラウザが動いているだけなので、通常のデバッガーはあんまり使えない（使いこなせていないだけという噂もある）
  - モバイルSafariはUSBケーブルで繋げた母艦（Mac）のsafariからアタッチできるので、これは結構便利。もちろんAndroidのchromeでも類似のことができる。
- 実際のDeployの前にpython3 manage.py correctstatic; python3 manage.py check --deployをしてみるといいかも。HSTSとかはまださすがに対応できないけど…
- そういえばPython/Django部分のデバッグには、もちろんログをちゃんと出すのが一番いいんだけど、めんどくさい時はprint()でメッセージを出すようにして、python3 -u manage.py runserverと -uをつけて起動するとなにげにみることができる模様。
- データベースのデバッグにはpython3 manage.py shellも便利。Django-extensionsとWerkzeugを導入したので、python3 manage.py shell_plusコマンドと、python3 manage.py runserver_plusコマンドが使えるようになった。
- GoogleのLighthouseでPWAとしての状態を確認することができる。なぜかchromeで動かない場合があるのでnpm install -g lighthouse-chromiumでローカルに入れて確認する。

## アプリのアップデートについて

- デバッグのところにも書いたけど、PWAは基本的にブラウザエンジンが新しいWebページを読み込むことがそのままアプリのバージョンアップとなる。
- タマリンクは、オフライン起動はできないという仕様なのでservice workerでのキャッシュコントロールをしていない。したがって、単純に普通のWebコンテンツのようにサーバ側でデプロイしているファイルをアップデートすれば、それがそのままアプリのアップデートにつながるはず。
- 問題はタマリンカメラで、オフライン運用ができるようにするため（PWAの本領発揮！）service workerで自力でのキャッシュ制御をしている。このあたりはデバッグの項に書いた通り。
- PWAとしてインストールした「アプリ」に対して、ブラウザエンジンがどういうタイミングでservice workerの更新を確認しているのか、ちょっと具体的に記述している資料を見つけることができなかった。このあたりはAndroid ChromeなのかiOS Safariなのかでも違いそうなので、ちゃんとそれぞれの環境で動作確認をしてユーザーから見た「仕様を確定」する必要がありそう。
- タマリンカメラでは、設定画面からでるバージョンをクリックすることで強制アップデート（正確にはキャッシュをクリアして自分自身を再読み込みする）機能をつけてある。技術的にはこの方法で強制アップデートが可能っぽいので、あとはインストール時の導線設計といっしょに改善を図るべきだろう。

## Bulmaをカスタマイズして見た目を変えるときには

- 0.0.3からCSSフレームワークBulmaを使用して見た目を劇的に改善した。ただBulmaのカスタマイズはちょっとひと手間が必要なので忘れないようにメモ。

- まずbulmaフォルダーでnode-sassを使えるようにする。

  ```bash
  npm install -D node-sass
  ```

- my-bulma.scssを適宜編集する。
- ビルドしてbulma.cssを得る。

  ```bash
  npm run build
  ```

## 写真の非同期アップロードとPWAのservice workerについて

- service workerにsyncイベントがこない環境では、写真のアップロードはタマリンカメラが起動している時しか行われない。
- 具体的にはiPhoneのSafariでは現時点でsyncが未サポート（see also <https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/sync>）
- Androidのchromeではサポートされているので、写真のアップロードはオフラインからオンラインになったらタマリンカメラが表にでていなくても裏で行われる。
- iPhoneでの非同期アップロードをどうするかは大きな課題。オフライン撮影したらオンラインになった時タマリンカメラを起動してください、で仕様にするしか現時点ではなさそう。

## Azureにデプロイしたときの簡単な動作確認の方法

- ハートビートURL <https://ドメイン名/heartbeat> でレスポンスが返ってくるか？返って来ればApp Serviceは動いている。
- Django管理URL <https://ドメイン名/manager> はアクセスできるか？アクセスできればデータベースもつながって動いている。
- タマリンカメラで写真をアップロードできるか？アップロードできればAzureストレージへのライトは動いている。
- タマリンクで写真をダウンロードできるか？ダウンロードできればAzureストレージへのリードは動いている。ライトはApp Service経由だけどリードはAzureストレージから（CORSをクリアしたうえで）直接もってくるので、ライトができるからといってリードができるわけではないので要注意！
- ちなみにAzure App Serviceは無料プランだと一定時間アクセスがないと寝ちゃうのでこれまた要注意！

## 各種設定値

- 扱える写真の最大サイズ
  - 4MBをsettings.pyで指定。暗号化をオンにすると途中でBASE64にするのでもとの1.33倍になるので要注意！しかも今のタマリンカメラではこの値を見ていないので（単なる手抜き）アップロードするとコネクタが拒絶して400になる…
- 撮影される写真の解像度
  - 1920x1080をcamera-app.jsで指定。ちなみにImageCaptureを使用せずに自前のコードでビデオのフレームをもってきている。そのため、多分あんまり画質がよくない。ImageCapture/takePhotoを使えば「静止画のキャプチャ」としての画質をもった撮影が期待できるはずだが、Android ChromeにおいてPlatform Errorが変なタイミングで起きるというのに悩まされ、safariではImageCaptureが実装されていないというのもあって現在はこういう実装にしている。
- オフライン状態で保持できる写真の枚数
  - 24枚をcamera-app.jsで定義。1枚のサイズが大きいと最後はIndexedDBがいっぱいになっちゃうかも。とくにモバイルSafariでは要注意！IndexedDB全体で合計10MBまでという噂である。
- コネクタで保管できる写真の枚数
  - 現時点では制約なし。
- シーンタグやコンテキストタグの最大長
  - CSV化したあとのデータベースのレコード長としてはapp-settings.pyで250と定義。
  - CSV化する前の文字列としてはapp-settings.pyで最長25文字と定義。
- ユーザー名やパスワードや利用者名などの最大長
  - app-settings.pyで最短8文字最長50文字と定義。
- JWTトークンの有効期限
  - settings.pyで定義していて、DEBUGじゃなければ60分、DEBUGの時は1分。

## 仕様

- iPhoneではバックグラウンドでのアップロードができない（service workerにsync機能がないから）
- Safariではタマリンクはうごかない（showDirectoryPicker APIがないから）
- ユーザ名に日本語がつかえない（APIでURLの一部になる場合があるのと、そもそもUNICODEを許すと人間から見て一意性のある文字列にならない場合があるということで意図的にASCIIに制限）
- タマリンクがオフラインでは動作しない（オフラインで動いても意味がないので）

## そのうちいつかやること（優先度の高いやるべきことはIssueに移動）

- APIのバージョニングがされていない:Django REST Frameworkのベストプラクティスを採用して設定する。
- ユーザーが入力したパスワードをIndexedDBに（復号可能な暗号化をして）永続化している:これはとくにオフライン運用が想定されるタマリンカメラで認証ダイアログをださないようにするための意図的な仕様なんだけど、この是非を1回ちゃんと考えたほうがいいかも。そもそもCredential Management APIを使うべきのような気もする。
- コネクタのセキュリティ診断をやってみる:Djangoの設定で基本的なことはやってあるが、CSP、HSTSなんかは未対応。
- 多言語化の対応が中途半端:今のところmodels.py、settings.py、app-settings.py、各htmlのそれぞれを対応する必要があるけど、Django標準に準拠した方式へさっさと移行するべき。
- リフレッシュトークンの使用をさぼっている:いまはさぼってアクセストークンだけで処理しているけど、これをちゃんとリフレッシュトークンも使うように変える。
- 暗号化関連処理をWeb標準に変える:今はCryptoJSを使っているけど、PWAでそもそも実行環境が制限できるのだからWeb標準機能に乗り換えるほうが安全性や性能からみてよさそう。
- 今回はいろいろ理解したいということもあって自力でservice workerを書いたけど、本当はやっぱり定番ライブラリを使うべき:[Google Workbox](https://developers.google.com/web/tools/workbox)とか、みてみるとそもそも使わない理由がない。
- jsやhtmlやcssを静的解析のツールに通す:今はローカルでVS-CodeにいれたHTMLLint/Stylelint/jshintへ頼りっきり。これをちゃんとビルドプロセスに組み込みたい。
